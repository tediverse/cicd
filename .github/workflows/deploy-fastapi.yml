name: Deploy FastAPI app

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      app_dir:
        required: true
        type: string
      alembic_migrate:
        required: false
        type: string
        default: "false"
      lxc_user:
        required: true
        type: string
      run_tests:
        required: false
        type: string
        default: "false"

    secrets:
      LXC_HOST:
        required: true
      ENV_FILE:
        required: true
      GH_RUNNER_KEY:
        required: true

jobs:
  test:
    if: ${{ inputs.run_tests == 'true' }}
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python3 -m venv .venv
          . .venv/bin/activate
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run tests
        env:
          PYTHONPATH: .
        run: |
          . .venv/bin/activate
          pytest -q

  deploy:
    runs-on: self-hosted
    needs: [test]
    if: ${{ always() && (inputs.run_tests == 'false' || needs.test.result == 'success') }}

    steps:
      - name: Checkout app code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: ./app

      - name: Checkout cicd repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/cicd
          path: ./.cicd

      - name: Copy deploy script
        run: |
          cp ./.cicd/scripts/deploy-fastapi.sh ./app/deploy.sh
          chmod +x ./app/deploy.sh

      - name: Copy .env (if exists)
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE }}
        if: env.ENV_FILE_CONTENT != ''
        run: |
          echo "${{ secrets.ENV_FILE }}" > ./app/.env

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.GH_RUNNER_KEY }}

      - name: Add LXC host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.LXC_HOST }} >> ~/.ssh/known_hosts

      - name: Rsync app files
        run: |
          rsync -avz --delete \
            --exclude '.git*' \
            --exclude '.github*' \
            --exclude '.venv' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            ./app/ ${{ inputs.lxc_user }}@${{ secrets.LXC_HOST }}:${{ inputs.app_dir }}

      - name: Execute deploy script
        run: |
          ssh ${{ inputs.lxc_user }}@${{ secrets.LXC_HOST }} \
          "cd ${{ inputs.app_dir }} && \
           SERVICE_NAME='${{ inputs.service_name }}' \
           ALEMBIC_MIGRATE='${{ inputs.alembic_migrate }}' \
           bash deploy.sh"
